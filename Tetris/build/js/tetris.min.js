var game={CSIZE:26,OFFSET:15,pg:null,shape:null,nextShape:null,timer:null,interVal:200,RN:20,CN:10,wall:null,score:0,lines:0,SCORES:[0,10,30,60,100],state:1,GAMEOVER:0,RUNNING:1,PAUSE:2,start:function(){this.state=this.RUNNING;this.score=0;this.lines=0;this.wall=[];for(var a=0;a<this.RN;a++){this.wall[a]=new Array(this.CN)}this.pg=document.getElementsByClassName("playground")[0];this.shape=this.randomShape();this.nextShape=this.randomShape();this.paint();this.timer=setInterval(this.moveDown.bind(this),this.interVal);document.onkeydown=function(b){switch(b.keyCode){case 32:this.state===this.RUNNING&&this.hardDrop();break;case 37:this.state===this.RUNNING&&this.moveLeft();break;case 38:this.state===this.RUNNING&&this.rotateR();break;case 90:this.state===this.RUNNING&&this.rotateL();break;case 39:this.state===this.RUNNING&&this.moveRight();break;case 40:this.state===this.RUNNING&&this.moveDown();break;case 83:this.state===this.GAMEOVER&&this.start();break;case 81:this.state!==this.GAMEOVER&&this.quit();break;case 80:this.state===this.RUNNING&&this.pause();break;case 67:this.state===this.PAUSE&&this.myContinue();break;default:break}}.bind(this)},myContinue:function(){this.state=this.RUNNING;this.timer=setInterval(this.moveDown.bind(this),this.interVal);this.paint()},pause:function(){this.state=this.PAUSE;clearInterval(this.timer);this.paint()},quit:function(){this.state=this.GAMEOVER;clearInterval(this.timer);this.paint()},canRotate:function(){for(var b=0;b<this.shape.cells.length;b++){var a=this.shape.cells[b];if(a.c<0||a.c>=this.CN||a.r<0||a.r>=this.RN||this.wall[a.r][a.c]!==undefined){return false}}return true},rotateR:function(){this.shape.rotateR();!this.canRotate()&&this.shape.rotateL();this.paint()},rotateL:function(){this.shape.rotateL();!this.canRotate()&&this.shape.rotateR();this.paint()},randomShape:function(){var a=Math.floor(Math.random()*3);switch(a){case 0:return new T();case 1:return new O();case 2:return new I();default:break}},hardDrop:function(){while(this.canDown()){this.moveDown()}},canLeft:function(){for(var b=0;b<this.shape.cells.length;b++){var a=this.shape.cells[b];if(a.c===0||this.wall[a.r][a.c-1]!==undefined){return false}}return true},moveLeft:function(){if(this.canLeft()){this.shape.moveLeft();this.paint()}},canRight:function(){for(var b=0;b<this.shape.cells.length;b++){var a=this.shape.cells[b];if(a.c===this.CN-1||this.wall[a.r][a.c+1]!==undefined){return false}}return true},moveRight:function(){if(this.canRight()){this.shape.moveRight();this.paint()}},canDown:function(){for(var b=0;b<this.shape.cells.length;b++){var a=this.shape.cells[b];if(a.r===this.RN-1||this.wall[a.r+1][a.c]!==undefined){return false}}return true},moveDown:function(){if(this.canDown()){this.shape.moveDown()}else{this.landIntoWall();var a=this.deleteRows();this.lines+=a;this.score+=this.SCORES[a];if(this.isGAMEOVER()){this.shape=this.nextShape;this.nextShape=this.randomShape()}else{this.state=this.GAMEOVER;clearInterval(this.timer)}}this.paint()},isGAMEOVER:function(){for(var b=0;b<this.nextShape.cells.length;b++){var a=this.nextShape.cells[b];if(this.wall[a.r][a.c]){return false}}return true},deleteRows:function(){for(var b=this.RN-1,a=0;b>=0;b--){if(this.isFullRow(b)){this.deleteRow(b);a++;if(this.wall[b-1].join("")===""||a===4){break}b++}}return a},deleteRow:function(a){for(;a>=0;a--){this.wall[a]=this.wall[a-1];this.wall[a-1]=new Array(this.CN);for(var b=0;b<this.CN;b++){this.wall[a][b]&&this.wall[a][b].r++}if(this.wall[a-2].join("")===""){break}}},isFullRow:function(a){return String(this.wall[a]).search(/^,|,,|,$/)===-1},landIntoWall:function(){for(var b=0;b<this.shape.cells.length;b++){var a=this.shape.cells[b];this.wall[a.r][a.c]=a}},paint:function(){this.pg.innerHTML=this.pg.innerHTML.replace(/<img [^>]*>/g,"");this.paintShape();this.paintWall();this.paintNext();this.paintScore();this.paintState()},paintShape:function(){var b=document.createDocumentFragment();for(var a=0;a<this.shape.cells.length;a++){b.appendChild(this.paintCell(this.shape.cells[a]))}this.pg.appendChild(b)},paintCell:function(a){var b=new Image();b.style.left=a.c*this.CSIZE+this.OFFSET+"px";b.style.top=a.r*this.CSIZE+this.OFFSET+"px";b.src=a.src;return b},paintWall:function(){var d=document.createDocumentFragment();for(var a=this.RN-1;a>=0;a--){if(this.wall[a].join("")===""){break}for(var b=0;b<this.CN;b++){if(this.wall[a][b]){d.appendChild(this.paintCell(this.wall[a][b]))}}}this.pg.appendChild(d)},paintNext:function(){var c=document.createDocumentFragment();for(var b=0;b<this.nextShape.cells.length;b++){var a=this.paintCell(this.nextShape.cells[b]);a.style.left=parseFloat(a.style.left)+10*this.CSIZE+"px";a.style.top=parseFloat(a.style.top)+this.CSIZE+"px";c.appendChild(a)}this.pg.appendChild(c)},paintScore:function(){document.getElementById("score").innerHTML=this.score;document.getElementById("lines").innerHTML=this.lines},paintState:function(){var a=new Image();if(this.state===this.GAMEOVER){a.src="img/game-over.png"}else{if(this.state===this.PAUSE){a.src="img/pause.png"}}a.className="state";this.pg.appendChild(a)}};game.start();